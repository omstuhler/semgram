#' Extraction function
#'
#' This function extracts motifs from text.
#'
#' @param tokens A tokens dataframe with predicted dependencies as generated by spacyr::spacy_parse(). Dependencies need to be in ClearNLP style. This tag set is used by all English language models implemented in spaCy. Other languages or dependency grammars are currently not supported.
#' @param entities Specifies the core entities around which to extract motifs.
#' This can be a single character string or a vector of character strings.
#' Multi-token strings such as "Harry Potter" will be parsed if parse_multi_token_entities is set to TRUE. Note that this parameter is case-sensitive.
#' @param motif_classes A character vector specifying which motif classes should be considered in the extraction.
#' This can include "A" for agents, "t" for treatments, "a" for actions, "P" for patients,
#' "be" for characterizations, "H" for possessions, as well as "At" and "aP" for agent-treatment and action-patient motifs respectively.
#' By default, all motif classes are considered. Note, however, that run time increases with the number of motif classes considered.
#' @param fast If set to true, some of the more specific extraction rules are not applied. This results in fewer extractions but faster run time. Defaults to FALSE.
#' @param parse_multi_token_entities Should we multi-token entities (e.g. "Harry Potter') be considered. Defaults to TRUE.
#' @param extract Parameter defines whether we extract the "lemma" or the "token" of a motif. Defaults to "lemma" which reduces sparsity and is preferable for most purposes.
#' @param markup If TRUE, motifs will be marked up according to their motif class. For instance, the action motif "sing" is extracted as "a_sing". Defaults to TRUE.
#' @param be_entity Should things that are linked to an entity via "being" (or one of it's lemmas) be considered as characterization motifs?
#' For example, say we are extracting characterization motifs around the entity "immigrants" in the sentence "my parents are immigrants", should we extract the characterization motif "be_parent"? Defaults to TRUE.
#' @param get_aux_verbs Should auxiliary verbs (e.g. can, could, may, must, etc.) be collected as actions? Defaults to FALSE.
#' @param aux_verb_markup Should auxiliary verbs with "to" be marked up so that "going" in "going to eat" becomes "going-to".
#' Note that this will not affect cases of the sort "going to the bar." This can be especially useful for analyses concerning modality.
#' The parameter defaults to TRUE.
#' @param pron_as_ap Should pronouns be considered as agents and patients? Defaults to FALSE.
#' @param use_appos Should things linked to an entity via an appositional modifier be considered as equivalent to the entity.
#' For example, if we specify our entity to be "Peter" in the sentence "My brother Peter left.", should "brother" be considered equivalent to "Peter"?
#' Only if use_appos = TRUE, we can extract "leaving" as action motif associated with Peter, as the subject associated with "leaving" is "brother".
#' @param lowercase Should tokens and lemmas be lowercased? Defaults to FALSE.
#' @param verbose Defaults to FALSE.
#' @return A list of length eight, one element for each motif class. List element of motif classes not specified in the motif_classes parameter will be empty.
#' @export

extract_motifs = function(tokens = NULL,
                          entities = NULL,
                          motif_classes = c("A","t", "a", "P", "be", "H", "At", "aP"),
                          fast = F,
                          parse_multi_token_entities = T,
                          extract = "lemma",
                          markup = T,
                          be_entity = T,
                          get_aux_verbs = F,
                          aux_verb_markup = T,
                          pron_as_ap = F,
                          use_appos = T,
                          lowercase = F,
                          verbose = F){


  ###############################################################################################
  #####################################Pre-processing############################################
  ###############################################################################################

  ###############################################################################################
  ##### Text input
  if(!exists("tokens")){
    message("It seems you didn't provide a tokens object.\n")
  }
  if(!exists("entities")){
    message("It seems you didn't specify any core entities to extract motifs around.\n")
  }

  ###############################################################################################
  ##### Unify column labels in tokens dataframe
  if("sentence_id" %in% names(tokens)){
    names(tokens)[which(names(tokens) == "sentence_id")] = "sentence"
  }
  if("dep_rel" %in% names(tokens)){
    names(tokens)[which(names(tokens) == "dep_rel")] = "relation"
  }


  ###############################################################################################
  ##### Replace

  # Get all instances of entities that are multigrams
  if(T %in% str_detect(entities, " ") & parse_multi_token_entities == T){
    for(entity in entities){
      if(entity == entities[1]){
        phrase_df = data.frame()
        master_length = dim(tokens)[1]
      }

      entity_split = unlist(spacy_parse(entity)$token)
      entity_length = length(entity_split)

      if(entity_length>1){
        if(verbose){cat("Replacing phrase: ", entity, "\n")}
        length_seq = 1:entity_length
        which_first_id = which(tokens[,"token"] == entity_split[1])

        for(rownumber in which_first_id-1){
          if(isTRUE(all.equal(unname(unlist(tokens[c(rownumber+length_seq), "lemma"])), entity_split))){
            for(token in length_seq){
              row_index = c(rownumber+token)
              if(nrow(phrase_df) == 0){
                phrase_df = rbind(phrase_df, c(tokens[row_index,],
                                               phrase_replacement = paste(entity_split, collapse = " ")),
                                  stringsAsFactors = F)
              } else {
                if(!paste(tokens[row_index,][,c("doc_id", "sentence","token_id")], collapse = "_") %in%
                   str_c(phrase_df$doc_id, phrase_df$sentence, phrase_df$token_id, sep = "_")){
                  phrase_df = rbind(phrase_df, c(tokens[row_index,],
                                                 phrase_replacement = paste(entity_split, collapse = " ")),
                                    stringsAsFactors = F)
                }
              }
            }
          }
        }
      }
    }

    # Merge in the phrase replacements
    if(exists("phrase_df") & nrow(phrase_df) > 0){
      tokens = left_join(tokens, phrase_df[,c("doc_id", "sentence", "token_id", "phrase_replacement")],
                         by = c("doc_id" = "doc_id",
                                "sentence" = "sentence",
                                "token_id" = "token_id"),
                         keep = F)

      tokens$token = ifelse(!is.na(tokens$phrase_replacement), tokens$phrase_replacement, tokens$token)
      #tokens = unique(tokens)
    } else {
      tokens$phrase_replacement = NA
    }
  } else {
    tokens$phrase_replacement = NA
  }
  if(T %in% str_detect(entities, " ") & parse_multi_token_entities == F){
    "Warning: multi-token entities were detected but parsing them was set to FALSE.\n"
  }


  ###############################################################################################
  ##### Mark up tokens with eligible appos children
  if(use_appos){
    appos_child = tquery(token = entities, relation = "appos",
                         parents(pos = c("NOUN", "PROPN", "PRON"), NOT(token = entities),
                                 label = "appos_child", fill = F
                         )
    )

    tokens = tokens %>%
      annotate_tqueries("appos_child", appos_child, overwrite = T, copy = F)
    tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    } else {
      tokens$appos_child = ""
  }


  ###############################################################################################
  ##### Set pronoun parameter
  if(pron_as_ap){
    agent_patient_pos = c("NOUN", "PROPN", "PRON")
    tokens$lemma = ifelse(tokens$lemma == "-PRON-", tokens$token, tokens$lemma)
    } else {
      agent_patient_pos = c("NOUN", "PROPN")
  }

  ###############################################################################################
  ##### Replace auxiliary phrases

  # Get going to, need to, etc. instances
  if(aux_verb_markup){
    if(verbose){cat("Replacing aux phrases.. ", "\n")}
    aux_phrases = list(c("going", "to"),
                       c("need", "to"), c("needed", "to"),
                       c("have", "to"), c("had", "to"),
                       c("ought", "to"))

    for(aux_phrase in 1:length(aux_phrases)){
      if(aux_phrase == 1){
        aux_phrase_df = data.frame()
        master_length = dim(tokens)[1]
      }

      aux_phrase_split = aux_phrases[[aux_phrase]]

      length_seq = 1:2
      which_first_id = which(tokens[,"token"] == aux_phrase_split[1])

      for(rownumber in which_first_id-1){
        if(isTRUE(all.equal(unname(unlist(tokens[c(rownumber+length_seq), "token"])), aux_phrase_split)) &
           tokens[rownumber+length_seq[2], "relation"] == "aux"){
          for(token in length_seq){
            row_index = c(rownumber+token)
            if(nrow(aux_phrase_df) == 0){
              aux_phrase_df = rbind(aux_phrase_df, c(tokens[row_index,],
                                                     aux_phrase_replacement = paste(aux_phrase_split, collapse = "-")),
                                stringsAsFactors = F)
            } else {
              if(!paste(tokens[row_index,][,c("doc_id", "sentence","token_id")], collapse = "_") %in%
                 str_c(aux_phrase_df$doc_id, aux_phrase_df$sentence, aux_phrase_df$token_id, sep = "_")){
                aux_phrase_df = rbind(aux_phrase_df, c(tokens[row_index,],
                                               aux_phrase_replacement = paste(aux_phrase_split, collapse = "-")),
                                  stringsAsFactors = F)
              }
            }
          }
        }
      }
    }

    # Merge in the phrase replacements
    if(exists("aux_phrase_df") & nrow(aux_phrase_df) > 0){
      tokens = left_join(tokens, aux_phrase_df[,c("doc_id", "sentence", "token_id", "aux_phrase_replacement")],
                         by = c("doc_id" = "doc_id",
                                "sentence" = "sentence",
                                "token_id" = "token_id"),
                         keep = F)

      tokens$token = ifelse(!is.na(tokens$aux_phrase_replacement), tokens$aux_phrase_replacement, tokens$token)
      tokens$lemma = ifelse(!is.na(tokens$aux_phrase_replacement), tokens$aux_phrase_replacement, tokens$lemma)
    } else {
      tokens$aux_phrase_replacement = ""
    }
  } else {
    tokens$aux_phrase_replacement = ""
  }

  ###############################################################################################
  ##### Set auxiliary markup parameter
  if(get_aux_verbs){
    if(!aux_verb_markup){
      message("You are extracting auxiliary verbs but aux_verb_markup is set to FALSE. This may not give ideal results.\n")
    }
    tokens$get_aux_verbs_par = "YES"
    verb_pos = c("VERB", "AUX")
  } else {
    tokens$get_aux_verbs_par = "NO"
    verb_pos = c("VERB")
  }

  ###############################################################################################
  ######################################Rule implementation######################################
  ###############################################################################################

  ###############################################################################################
  ############################################Acts###############################################
  ###############################################################################################

  if("a" %in% motif_classes){
    if(verbose){cat("Extracting actions\n")}
    ###############################################################################################
    ##### Rule: nsubj act or conjuncted second verb
    ##### Example: "ENTITY asked Joe." (asked)
    ##### Example: "ENTITY called and asked Joe." (called, asked)
    ##### Note: Note that the current basic annotation scheme cannot distinguish between a dependent of the first
    ##### conjunct and a shared dependent of the whole coordination (see https://universaldependencies.org/u/dep/conj.html).
    ##### E.g. in "ENTITY called and Joe answered." "answered" would be picked up as action of ENTITY if we just took conj-dependents.
    ##### To prevent this, we add a not_children condition to avoid cases where an independent subject is named.
    tryCatch({
      nsubj_act_conj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                              parents(pos = verb_pos,
                                      label = "Motif", fill = F,
                                      children(pos = verb_pos, relation = "conj", req = F,
                                               not_children(relation = "nsubj", depth = 1),
                                               label = "Motif", fill = F,
                                               children(get_aux_verbs_par = "YES",
                                                        pos = verb_pos, relation = "aux", req = F,
                                                        label = "Motif", fill = F
                                               )
                                      ),
                                      children(get_aux_verbs_par = "YES",
                                               pos = verb_pos, relation = "aux", req = F,
                                               label = "Motif", fill = F
                                      )
                              )
      )

      tokens = tokens %>%
        annotate_tqueries("nsubj_act_conj", nsubj_act_conj, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

    }, error = function(e){
      message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
      tokens$nsubj_act_conj <<- NA
    })



    ###############################################################################################
    ##### Rule: nsubj with conjuncted second actor and possibly second verb
    ##### Example: "Joe and ENTITY called Steve" (called)
    ##### Example: "Joe and ENTITY called and asked Steve." (called, asked)
    if(fast){
      tokens$nsubj_act_noun_conj_verb_conj = NA
    } else {
      tryCatch({
        nsubj_act_noun_conj_verb_conj = tquery(OR(token = entities, appos_child = "appos_child"),
                                               relation = "conj",
                                               parents(pos = c("NOUN", "PROPN", "PRON"),  relation = "nsubj",
                                                       parents(pos = verb_pos,
                                                               label = "Motif", fill = F,
                                                               children(pos = verb_pos, relation = "conj", req = F,
                                                                        not_children(relation = "nsubj", depth = 1),
                                                                        label = "Motif", fill = F,
                                                                        children(get_aux_verbs_par = "YES",
                                                                                 pos = verb_pos, relation = "aux", req = F,
                                                                                 label = "Motif", fill = F
                                                                        ),
                                                                        children(get_aux_verbs_par = "YES",
                                                                                 pos = verb_pos, relation = "aux", req = F,
                                                                                 label = "Motif", fill = F
                                                                        )
                                                               )
                                                       )
                                               )
        )

        tokens = tokens %>%
          annotate_tqueries("nsubj_act_noun_conj_verb_conj", nsubj_act_noun_conj_verb_conj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      },error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$nsubj_act_noun_conj_verb_conj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive subject with by
    ##### Example: "Sue is asked by Entity." (asked)
    if(fast){
      tokens$by_act = NA
    } else {
      tryCatch({
        by_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                        parents(pos = "ADP", lemma = "by", relation = "agent",
                                parents(pos = "VERB",
                                        label = "Motif", fill = F)))

        tokens = tokens %>%
          annotate_tqueries("by_act", by_act, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act <<- NA
      })
    }


    ###############################################################################################
    ##### Rule: Passive subject with by and noun conjunct
    ##### Example: "Sue is asked by Steve and ENTITY." (asked)
    if(fast){
      tokens$by_act_noun_conjunct = NA
    } else {
      tryCatch({
        by_act_noun_conjunct = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                      parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                              parents(pos = "ADP", lemma = "by", relation = "agent",
                                                      parents(pos = "VERB",
                                                              label = "Motif", fill = F
                                                      )
                                              )
                                      )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_noun_conjunct", by_act_noun_conjunct, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act_noun_conjunct <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive subject with by conjunction
    ##### Example: "Sue is called and asked by ENTITY." (called)
    if(fast){
      tokens$by_act_2 = NA
    } else {
      tryCatch({
        by_act_2 = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                          parents(pos = "ADP", lemma = "by", relation = "agent",
                                  parents(pos = c("VERB", "AUX"), relation = "conj",
                                          parents(pos = "VERB",
                                                  label = "Motif", fill = F)
                                  )
                          )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_2", by_act_2, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act_2 <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive subject with by conjunction second verb
    ##### Example: "Sue is called and asked by ENTITY." (asked)
    if(fast){
      tokens$by_act_2_1 = NA
    } else {
      tryCatch({
        by_act_2_1 = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                            parents(pos = "ADP", lemma = "by", relation = "agent",
                                    parents(pos = "VERB", relation = "conj",
                                            label = "Motif", fill = F
                                    )
                            )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_2_1", by_act_2_1, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act_2_1 <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive subject with by verb conjunction and noun conjunction
    ##### Example: "Sue is called and asked by Greg and ENTITY" (called)
    if(fast){
      tokens$by_act_2_noun_conj = NA
    } else {
      tryCatch({
        by_act_2_noun_conj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                    parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                            parents(pos = "ADP", lemma = "by", relation = "agent",
                                                    parents(pos = c("VERB", "AUX"), relation = "conj",
                                                            parents(pos = "VERB",
                                                                    label = "Motif", fill = F
                                                            )
                                                    )
                                            )
                                    )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_2_noun_conj", by_act_2_noun_conj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act_2_noun_conj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive subject with by verb conjunction and noun conjunction (second verb)
    ##### Example: "Sue is called and asked by Greg and ENTITY." (asked)
    if(fast){
      tokens$by_act_2_noun_conj_1 = NA
    } else {
      tryCatch({
        by_act_2_noun_conj_1 = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                      parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                              parents(pos = "ADP", lemma = "by", relation = "agent",
                                                      parents(pos = c("VERB"), relation = "conj",
                                                              label = "Motif", fill = F
                                                      )
                                              )
                                      )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_2_noun_conj_1", by_act_2_noun_conj_1, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$by_act_2_noun_conj_1 <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Verb with xcomp clause and its conjuncts
    ##### Example: "ENTITY wants to eat and drink." (eat, drink)
    ##### Note: not_children inserted is in order to avoid passiveness.
    if(fast){
      tokens$xcomp_act_conj_verb = NA
    } else {
      tryCatch({
        xcomp_act_conj_verb = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                     parents(pos = c("VERB", "AUX"),
                                             children(pos = "VERB", relation = "xcomp",
                                                      not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                      not_children(relation = "nsubj"),
                                                      label = "Motif", fill = F,
                                                      children(pos = "VERB", relation = "conj", req = F,
                                                               not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                               not_children(relation = "nsubj"),
                                                               label = "Motif", fill = F,
                                                               children(pos = "VERB", relation = "conj", req = F,
                                                                        not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                        not_children(relation = "nsubj"),
                                                                        label = "Motif", fill = F
                                                               )
                                                      )
                                             )

                                     )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_conj_verb", xcomp_act_conj_verb, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$xcomp_act_conj_verb <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Verb with xcomp clause and noun conjunct
    ##### Example: "Jack and ENTITY want to eat." (eat)
    ##### Note: not_children inserted in order to avoid passiveness.
    if(fast){
      tokens$xcomp_act_conj_noun = NA
    } else {
      tryCatch({
        xcomp_act_conj_noun = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                     parents(pos = c("PROPN", "NOUN", "PRON"), relation = "nsubj",
                                             parents(pos = c("VERB", "AUX"),
                                                     children(pos = "VERB", relation = "xcomp",
                                                              not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                              not_children(relation = "nsubj"),
                                                              label = "Motif", fill = F,
                                                              children(pos = "VERB", relation = "conj", req = F,
                                                                       not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                       not_children(relation = "nsubj"),
                                                                       label = "Motif", fill = F)
                                                     )
                                             )
                                     )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_conj_noun", xcomp_act_conj_noun, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting action motifs. Some action motifs might not have been extracted properly.")
        tokens$xcomp_act_conj_noun <<- NA
      })
    }
  }


  ###############################################################################################
  #########################################Patients##############################################
  ###############################################################################################

  if("P" %in% motif_classes){
    if(verbose){cat("Extracting patients\n")}
    ###############################################################################################
    ##### Rule: Object of nsubj act
    ##### Example: "ENTITY calls Joe, Sue, and Michael." (Joe, Sue, Michael)
    ##### Example: "ENTITY give Joseph a present." (Joseph, present)
    ##### Example: "ENTITY called my friend Peter." (friend, Peter)
    ##### Note: The last sentence exemplifies how appositions are considered. This presumes that use_appos is set to TRUE.
    tryCatch({
      nsubj_obj_conj_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                  parents(pos = c("VERB", "AUX"), NOT(lemma = "have"),
                                          children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Motif",
                                                   fill = F,
                                                   children(pos = agent_patient_pos, relation = c("conj", "appos"), depth = 3, req = F,
                                                            label = "Motif",
                                                            fill = F
                                                   )
                                          )
                                  )
      )

      tokens = tokens %>% annotate_tqueries("nsubj_obj_conj_act", nsubj_obj_conj_act, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

    }, error = function(e){
      message("There was an error in extracting Patient motifs. Some Patient motifs might not have been extracted properly.")
      tokens$nsubj_obj_conj_act <<- NA
    })



    ###############################################################################################
    ##### Rule: Object of nsubj act but ENTITY is conjunct of nominal subject
    ##### Example: "Joe and ENTITY asked Joe, Sue, and Michael." (Joe, Sue, Michael)
    ##### Example: "Steven and ENTITY give Joseph a present." (Joe, Sue, Michael)
    ##### Example: "Steven and ENTITY had lunch." (Joe, Sue, Michael)
    if(fast){
      tokens$nsubj_obj_conj = NA
    } else {
      tryCatch({
        nsubj_obj_conj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                parents(pos = agent_patient_pos, relation = "nsubj",
                                        parents(pos = c("VERB", "AUX"), NOT(lemma = "have"),
                                                children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Motif",
                                                         fill = F,
                                                         children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                  label = "Motif", fill = F, depth = 3
                                                         )
                                                )
                                        )
                                )
        )

        tokens = tokens %>% annotate_tqueries("nsubj_obj_conj", nsubj_obj_conj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting Patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$nsubj_obj_conj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of conjuncted verb
    ##### Example: "ENTITY came and kissed Joe, Sue, and Michael." (Joe, Sue, Michael)
    ##### Example: "ENTITY came and gave Steve a present." (Steve, present)
    if(fast){
      tokens$nsubj_conj_obj_act = NA
    } else {
      tryCatch({
        nsubj_conj_obj_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                    parents(pos = c("VERB", "AUX"),
                                            children(pos = c("VERB", "AUX"), relation = "conj",
                                                     NOT(lemma = "have"),
                                                     not_children(relation = "nsubj", depth = 1),
                                                     children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                              label = "Motif",
                                                              fill = F,
                                                              children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                       label = "Motif", req = F, depth = 3,
                                                                       fill = F
                                                              )
                                                     )
                                            )
                                    )
        )


        tokens = tokens %>%
          annotate_tqueries("nsubj_conj_obj_act", nsubj_conj_obj_act, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$nsubj_conj_obj_act <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of conjuncted verb but ENTITY is conjunct of nominal subject
    ##### Example: "Joe and ENTITY came and kissed Joe, Sue, and Michael." (Joe, Sue, Michael)
    ##### Example: "Joe and ENTITY came and gave Steve a present." (Steve, present)
    if(fast){
      tokens$nsubj_conj_subj_cons_obj = NA
    } else {
      tryCatch({
        nsubj_conj_subj_cons_obj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                          parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                  parents(pos = c("VERB", "AUX"),
                                                          children(pos = c("VERB", "AUX"), relation = "conj",
                                                                   NOT(lemma = "have"),
                                                                   not_children(relation = "nsubj", depth = 1),
                                                                   children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                            label = "Motif",
                                                                            fill = F,
                                                                            children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                                     label = "Motif", req = F, depth = 3,
                                                                                     fill = F
                                                                            )
                                                                   )
                                                          )
                                                  )
                                          )
        )

        tokens = tokens %>%
          annotate_tqueries("nsubj_conj_subj_cons_obj", nsubj_conj_subj_cons_obj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$nsubj_conj_subj_cons_obj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by
    ##### Example: "Joe, Sue, and Michael are asked by ENTITY." (Joe, Sue, Michael)
    ##### Example: "Steve is given a present by ENTITY" (Steve, present)
    if(fast){
      tokens$by_act_obj = NA
    } else {
      tryCatch({
        by_act_obj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                            parents(pos = "ADP", lemma = "by", relation = "agent",
                                    parents(pos = c("VERB", "AUX"),
                                            children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                     label = "Motif", fill = F,
                                                     children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                              label = "Motif", fill = F, depth = 3
                                                     )
                                            )
                                    )
                            )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj", by_act_obj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$by_act_obj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and noun conjunct
    ##### Example: "Joseph, Sue, and Michael are asked by Jack and ENTITY." (Joe, Sue, Michael)
    ##### Example: "Mike and Steve were given a present by Jack and ENTITY." (Steve, present)
    if(fast){
      tokens$by_act_obj_nc = NA
    } else {
      tryCatch({
        by_act_obj_nc = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                               parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                       parents(pos = "ADP", lemma = "by", relation = "agent",
                                               parents(pos = c("VERB", "AUX"),
                                                       children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                label = "Motif", fill = F,
                                                                children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                         label = "Motif", fill = F, depth = 3
                                                                )
                                                       )
                                               )
                                       )
                               )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_nc", by_act_obj_nc, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$by_act_obj_nc <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb
    ##### Example: "Joseph, Sue and Michael were called and asked by ENTITY." (Joseph, Sue, Michael)
    if(fast){
      tokens$by_act_obj_cverb = NA
    } else {
      tryCatch({
        by_act_obj_cverb = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                                  parents(pos = "ADP", lemma = "by", relation = "agent",
                                          parents(pos = "VERB", relation = "conj",
                                                  parents(pos = "VERB",
                                                          children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                   label = "Motif", fill = F,
                                                                   children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                            label = "Motif", fill = F, depth = 3
                                                                   )
                                                          )
                                                  )
                                          )
                                  )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb", by_act_obj_cverb, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$by_act_obj_cverb <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb and conjuncted subject
    ##### Example: "Joseph, Sue and Michael were called and asked by Jack and ENTITY." (Joseph, Sue, Michael)
    if(fast){
      tokens$by_act_obj_cverb_cobj = NA
    } else {
      tryCatch({
        by_act_obj_cverb_cobj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                       parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                               parents(pos = "ADP", lemma = "by", relation = "agent",
                                                       parents(pos = "VERB", relation = "conj",
                                                               parents(pos = "VERB",
                                                                       children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                                label = "Motif", fill = F,
                                                                                children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                                         label = "Motif", fill = F, depth = 3
                                                                                )
                                                                       )
                                                               )
                                                       )
                                               )
                                       )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb_cobj", by_act_obj_cverb_cobj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$by_act_obj_cverb_cobj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause
    ##### Example: "ENTITY wants to eat rice, grapes, and steak." (rice, grapes, steak)
    ##### Example: "ENTITY wants to give Steve a present." (Steve, present)
    ##### Note: not_children inserted in order to avoid passiveness.
    if(fast){
      tokens$xcomp_act_obj = NA
    } else {
      tryCatch({
        xcomp_act_obj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                               parents(pos = c("VERB", "AUX"),
                                       children(pos = "VERB", relation = "xcomp",
                                                NOT(lemma = "have"),
                                                not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                not_children(relation = "nsubj"),
                                                children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                         label = "Motif", fill = F,
                                                         children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                  label = "Motif", fill = F, depth = 3
                                                         )
                                                )
                                       )
                               )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj", xcomp_act_obj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$xcomp_act_obj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause and verb conjunct
    ##### Example: "ENTITY wants to chat and eat rice, grapes, and steak." (rice, grapes, steak)
    ##### Example: "ENTITY wants to chat and give Steven a present." (Steven, present)
    ##### Note: not_children inserted in order to avoid passiveness.
    if(fast){
      tokens$xcomp_act_obj_vconj = NA
    } else {
      tryCatch({
        xcomp_act_obj_vconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                     parents(pos = c("VERB", "AUX"),
                                             children(pos = "VERB", relation = "xcomp",
                                                      not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                      not_children(relation = "nsubj"),
                                                      children(pos = "VERB", relation = "conj",
                                                               NOT(lemma = "have"),
                                                               children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                        label = "Motif", fill = F,
                                                                        children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                 label = "Motif", fill = F, depth = 3
                                                                        )
                                                               )
                                                      )
                                             )
                                     )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_vconj", xcomp_act_obj_vconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$xcomp_act_obj_vconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of verb with xcomp clause and ENTITY as subject conjunct
    ##### Example: "Jonathan and ENTITY want to eat rice, grapes, and steak." (rice, grapes, steak)
    ##### Example: "Jonathan and ENTITY want to give Steven a present." (Steven, present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      tokens$xcomp_act_obj_nconj = NA
    } else {
      tryCatch({
        xcomp_act_obj_nconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                     parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                             parents(pos = c("VERB", "AUX"),
                                                     children(pos = "VERB", relation = "xcomp",
                                                              not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                              not_children(relation = "nsubj"),
                                                              NOT(lemma = "have"),
                                                              children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                       label = "Motif", fill = F,
                                                                       children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                label = "Motif", fill = F, depth = 3
                                                                       )
                                                              )
                                                     )
                                             )
                                     )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_nconj", xcomp_act_obj_nconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$xcomp_act_obj_nconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of verb with xcomp clause, conjuncted transitive verb, and ENTITY as subject conjunct
    ##### Example: "Jonathan and ENTITY want to swim and eat rice, grapes, and steak." (rice, grapes, steak)
    ##### Example: "Jonathan and ENTITY want to swim and give Steven a present." (Steven, present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      tokens$xcomp_act_obj_nconj_vconj = NA
    } else {
      tryCatch({
        xcomp_act_obj_nconj_vconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                           parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                   parents(pos = c("VERB", "AUX"),
                                                           children(pos = "VERB", relation = "xcomp",
                                                                    not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                    not_children(relation = "nsubj"),
                                                                    children(pos = "VERB", relation = "conj",
                                                                             NOT(lemma = "have"),
                                                                             children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                                      label = "Motif", fill = F,
                                                                                      children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                               label = "Motif", fill = F, depth = 3
                                                                                      )
                                                                             )
                                                                    )

                                                           )
                                                   )
                                           )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_nconj_vconj", xcomp_act_obj_nconj_vconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting patient motifs. Some patient motifs might not have been extracted properly.")
        tokens$xcomp_act_obj_nconj_vconj <<- NA
      })
    }
  }



  ###############################################################################################
  #####################################Action & Patients#########################################
  ###############################################################################################

  if("aP" %in% motif_classes){
    if(verbose){cat("Extracting action-patients\n")}
    ###############################################################################################
    ##### Rule: Object of nsubj act
    ##### Example: "ENTITY asked Joe, Sue, and Michael." (asked, Joe Sue Michael)
    ##### Example: "ENTITY give Joseph a present." (give, Joseph present)
    tryCatch({
      nsubj_obj_conj_act_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                     parents(pos = c("VERB", "AUX"),
                                             fill = F, label = "act",
                                             NOT(lemma = "have"),
                                             children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Patient",
                                                      fill = F,
                                                      children(pos = agent_patient_pos, relation = c("conj", "appos"), depth = 3, req = F,
                                                               label = "Patient",
                                                               fill = F
                                                      )
                                             )
                                     )
      )

      tokens = tokens %>% annotate_tqueries("nsubj_obj_conj_act_aP", nsubj_obj_conj_act_aP, overwrite = T, copy = F)

      if(all(is.na(tokens$nsubj_obj_conj_act_aP))){
        nsubj_obj_conj_act_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      } else {
        nsubj_obj_conj_act_aP_casted = cast_text(tokens, 'nsubj_obj_conj_act_aP', text_col = extract)
      }

    }, error = function(e){
      message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
      nsubj_obj_conj_act_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$nsubj_obj_conj_act_aP <<- NA
    })



    ###############################################################################################
    ##### Rule: Object of nsubj act but ENTITY is conjunct of nominal subject
    ##### Example: "Steven and ENTITY asked Joe, Sue, and Michael." (ask, Joe Sue Michael)
    ##### Example: "Steven and ENTITY give Joseph a present." (give, Joseph present)
    ##### Example: "Steven and ENTITY had lunch." (had, lunch)
    if(fast){
      nsubj_obj_conj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$nsubj_obj_conj_aP = NA
    } else {
      tryCatch({
        nsubj_obj_conj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                   parents(pos = agent_patient_pos, relation = "nsubj",
                                           parents(pos = c("VERB", "AUX"), label = "act", fill = F,
                                                   NOT(lemma = "have"),
                                                   children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Patient",
                                                            fill = F,
                                                            children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                     depth = 3, label = "Patient",
                                                                     fill = F
                                                            )
                                                   )
                                           )
                                   )
        )

        tokens = tokens %>% annotate_tqueries("nsubj_obj_conj_aP", nsubj_obj_conj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$nsubj_obj_conj_aP))){
          nsubj_obj_conj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          nsubj_obj_conj_aP_casted = cast_text(tokens, 'nsubj_obj_conj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        nsubj_obj_conj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$nsubj_obj_conj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of conjuncted verb
    ##### Example: "ENTITY came and kissed Joe, Sue, and Michael." (kissed, Joe Sue Michael)
    ##### Example: "ENTITY came and gave Steve a present." (gave, Steve present)
    if(fast){
      nsubj_conj_obj_act_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$nsubj_conj_obj_act_aP = NA
    } else {
      tryCatch({
        nsubj_conj_obj_act_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                       parents(pos = c("VERB", "AUX"),
                                               children(pos = c("VERB", "AUX"), relation = "conj",
                                                        label = "act", fill = F,
                                                        NOT(lemma = "have"),
                                                        not_children(relation = "nsubj", depth = 1),
                                                        children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                 label = "Patient",
                                                                 fill = F,
                                                                 children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                          label = "Patient", req = F, depth = 3,
                                                                          fill = F
                                                                 )
                                                        )
                                               )
                                       )
        )


        tokens = tokens %>%
          annotate_tqueries("nsubj_conj_obj_act_aP", nsubj_conj_obj_act_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$nsubj_conj_obj_act_aP))){
          nsubj_conj_obj_act_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          nsubj_conj_obj_act_aP_casted = cast_text(tokens, 'nsubj_conj_obj_act_aP', text_col= extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        nsubj_conj_obj_act_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$nsubj_conj_obj_act_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of conjuncted verb but ENTITY is conjunct of nominal subject
    ##### Example: "Joe and ENTITY came and kissed Joe, Sue, and Michael." (kissed, Joe Sue Michael)
    ##### Example: "Joe and ENTITY came and gave Steve a present." (gave, Steve present)
    if(fast){
      nsubj_conj_subj_cons_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$nsubj_conj_subj_cons_obj_aP = NA
    } else {
      tryCatch({
        nsubj_conj_subj_cons_obj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                             parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                     parents(pos = c("VERB", "AUX"),
                                                             children(pos = c("VERB", "AUX"), relation = "conj",
                                                                      fill = F, label = "act",
                                                                      NOT(lemma = "have"),
                                                                      not_children(relation = "nsubj", depth = 1),
                                                                      children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                               label = "Patient",
                                                                               fill = F,
                                                                               children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                                        label = "Patient", req = F, depth = 3,
                                                                                        fill = F
                                                                               )
                                                                      )
                                                             )
                                                     )
                                             )
        )

        tokens = tokens %>%
          annotate_tqueries("nsubj_conj_subj_cons_obj_aP", nsubj_conj_subj_cons_obj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$nsubj_conj_subj_cons_obj_aP))){
          nsubj_conj_subj_cons_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          nsubj_conj_subj_cons_obj_aP_casted = cast_text(tokens, 'nsubj_conj_subj_cons_obj_aP', text_col= extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        nsubj_conj_subj_cons_obj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$nsubj_conj_subj_cons_obj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by
    ##### Example: "Joe, Susan, and Michael are asked by ENTITY." (asked, Joe Sue Michael)
    ##### Example: "Steve is given a present by ENTITY." (given, Steve present)
    if(fast){
      by_act_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_aP = NA
    } else {
      tryCatch({
        by_act_obj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                               parents(pos = "ADP", lemma = "by", relation = "agent",
                                       parents(pos = c("VERB", "AUX"),
                                               label = "act", fill = F,
                                               NOT(lemma = "have"),
                                               children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                        label = "Patient", fill = F,
                                                        children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                 label = "Patient", fill = F, depth = 3
                                                        )
                                               )
                                       )
                               )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_aP", by_act_obj_aP, overwrite = T, copy = F)
        if(all(is.na(tokens$by_act_obj_aP))){
          by_act_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_aP_casted = cast_text(tokens, 'by_act_obj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and noun conjunct
    ##### Example: "Joseph, Sue and Michael are asked by Jack and ENTITY." (asked, Joe Sue Michael)
    ##### Example: "Mike and Steve were given a present by Jack and ENTITY." (given, Steve present)
    if(fast){
      by_act_obj_nc_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_nc_aP = NA
    } else {
      tryCatch({
        by_act_obj_nc_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                  parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                          parents(pos = "ADP", lemma = "by", relation = "agent",
                                                  parents(pos = c("VERB", "AUX"),
                                                          label = "act", fill = F,
                                                          NOT(lemma = "have"),
                                                          children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                   label = "Patient", fill = F,
                                                                   children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                            label = "Patient", fill = F, depth = 3
                                                                   )
                                                          )
                                                  )
                                          )
                                  )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_nc_aP", by_act_obj_nc_aP, overwrite = T, copy = F)


        if(all(is.na(tokens$by_act_obj_nc_aP))){
          by_act_obj_nc_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_nc_aP_casted = cast_text(tokens, 'by_act_obj_nc_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_nc_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_nc_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb (first verb)
    ##### Example: "Joseph, Sue and Michael were called and asked by ENTITY." (asked, Joseph Sue Michael)
    if(fast){
      by_act_obj_cverb_1_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_cverb_1_aP = NA
    } else {
      tryCatch({
        by_act_obj_cverb_1_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                                       parents(pos = "ADP", lemma = "by", relation = "agent",
                                               parents(pos = "VERB", relation = "conj",
                                                       label = "act", fill = F,
                                                       NOT(lemma = "have"),
                                                       parents(pos = "VERB",
                                                               children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                        label = "Patient", fill = F,
                                                                        children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                                 label = "Patient", fill = F, depth = 3
                                                                        )
                                                               )
                                                       )
                                               )
                                       )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb_1_aP", by_act_obj_cverb_1_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$by_act_obj_cverb_1_aP))){
          by_act_obj_cverb_1_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_cverb_1_aP_casted = cast_text(tokens, 'by_act_obj_cverb_1_aP', text_col= extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_cverb_1_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_cverb_1_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb (second verb)
    ##### Example: "Joseph, Sue and Michael were called and asked by ENTITY." (called, Joseph Sue Michael)
    if(fast){
      by_act_obj_cverb_2_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_cverb_2_aP = NA
    } else {
      tryCatch({
        by_act_obj_cverb_2_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                                       parents(pos = "ADP", lemma = "by", relation = "agent",
                                               parents(pos = "VERB", relation = "conj",
                                                       parents(pos = "VERB",
                                                               label = "act", fill = F,
                                                               NOT(lemma = "have"),
                                                               children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                        label = "Patient", fill = F,
                                                                        children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                                 label = "Patient", fill = F, depth = 3
                                                                        )
                                                               )
                                                       )
                                               )
                                       )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb_2_aP", by_act_obj_cverb_2_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$by_act_obj_cverb_2_aP))){
          by_act_obj_cverb_2_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_cverb_2_aP_casted = cast_text(tokens, 'by_act_obj_cverb_2_aP', text_col= extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_cverb_2_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_cverb_2_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb and conjuncted noun (first verb)
    ##### Example: "Joseph, Sue and Michael were called and asked by Jack and ENTITY." (asked, Joseph Sue Michael)
    if(fast){
      by_act_obj_cverb_cobj_1_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_cverb_cobj_1_aP = NA
    } else {
      tryCatch({
        by_act_obj_cverb_cobj_1_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                            parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                                    parents(pos = "ADP", lemma = "by", relation = "agent",
                                                            parents(pos = "VERB", relation = "conj",
                                                                    label = "act", fill = F,
                                                                    NOT(lemma = "have"),
                                                                    parents(pos = "VERB",
                                                                            children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                                     label = "Patient", fill = F,
                                                                                     children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                                              label = "Patient", fill = F, depth = 3
                                                                                     )
                                                                            )
                                                                    )
                                                            )
                                                    )
                                            )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb_cobj_1_aP", by_act_obj_cverb_cobj_1_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$by_act_obj_cverb_cobj_1_aP))){
          by_act_obj_cverb_cobj_1_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_cverb_cobj_1_aP_casted = cast_text(tokens, 'by_act_obj_cverb_cobj_1_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_cverb_cobj_1_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_cverb_cobj_1_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of passive subject with by and conjuncted verb and conjuncted noun (second verb)
    ##### Example: "Joseph, Sue and Michael were called and asked by Jack and ENTITY." (called, Joseph Sue Michael)
    if(fast){
      by_act_obj_cverb_cobj_2_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$by_act_obj_cverb_cobj_2_aP = NA
    } else {
      tryCatch({
        by_act_obj_cverb_cobj_2_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                            parents(pos = c("NOUN", "PROPN", "PRON"), relation = "pobj",
                                                    parents(pos = "ADP", lemma = "by", relation = "agent",
                                                            parents(pos = "VERB", relation = "conj",
                                                                    parents(pos = "VERB",
                                                                            label = "act", fill = F,
                                                                            NOT(lemma = "have"),
                                                                            children(relation = c("nsubjpass", "dobj"), pos = agent_patient_pos,
                                                                                     label = "Patient", fill = F,
                                                                                     children(relation = c("conj", "appos"), pos = agent_patient_pos, req = F,
                                                                                              label = "Patient", fill = F, depth = 3
                                                                                     )
                                                                            )
                                                                    )
                                                            )
                                                    )
                                            )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_obj_cverb_cobj_2_aP", by_act_obj_cverb_cobj_2_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$by_act_obj_cverb_cobj_2_aP))){
          by_act_obj_cverb_cobj_2_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          by_act_obj_cverb_cobj_2_aP_casted = cast_text(tokens, 'by_act_obj_cverb_cobj_2_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        by_act_obj_cverb_cobj_2_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$by_act_obj_cverb_cobj_2_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause
    ##### Example: "ENTITY wants to eat rice, grapes, and, steak." (eat, rice grapes steak)
    ##### Example: "ENTITY wants to give Steve a present." (give, Steve present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      xcomp_act_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$xcomp_act_obj_aP = NA
    } else {
      tryCatch({
        xcomp_act_obj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                  parents(pos = c("VERB", "AUX"),
                                          children(pos = "VERB", relation = "xcomp",
                                                   label = "act", fill = F,
                                                   NOT(lemma = "have"),
                                                   not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                   not_children(relation = "nsubj"),
                                                   children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                            label = "Patient", fill = F,
                                                            children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                     label = "Patient", fill = F, depth = 3
                                                            )
                                                   )
                                          )
                                  )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_aP", xcomp_act_obj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$xcomp_act_obj_aP))){
          xcomp_act_obj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          xcomp_act_obj_aP_casted = cast_text(tokens, 'xcomp_act_obj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        xcomp_act_obj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$xcomp_act_obj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause and verb conjunct
    ##### Example: "ENTITY wants to chat and eat rice, grapes, and steak." (eat, rice grapes steak)
    ##### Example: "ENTITY wants to chat and give Steven a present." (give, Steven present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      xcomp_act_obj_vconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$xcomp_act_obj_vconj_aP = NA
    } else {
      tryCatch({
        xcomp_act_obj_vconj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                        parents(pos = c("VERB", "AUX"),
                                                children(pos = "VERB", relation = "xcomp",
                                                         not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                         not_children(relation = "nsubj"),
                                                         children(pos = "VERB", relation = "conj",
                                                                  label = "act", fill = F,
                                                                  NOT(lemma = "have"),
                                                                  children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                           label = "Patient", fill = F,
                                                                           children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                    label = "Patient", fill = F, depth = 3
                                                                           )
                                                                  )
                                                         )
                                                )
                                        )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_vconj_aP", xcomp_act_obj_vconj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$xcomp_act_obj_vconj_aP))){
          xcomp_act_obj_vconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          xcomp_act_obj_vconj_aP_casted = cast_text(tokens, 'xcomp_act_obj_vconj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        xcomp_act_obj_vconj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$xcomp_act_obj_vconj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of verb with xcomp clause and ENTITY as subject conjunct
    ##### Example: "Jonathan and ENTITY want to eat rice, grapes, and steak." (eat, rice grapes steak)
    ##### Example: "Jonathan and ENTITY want to give Steven a present." (give, Steven present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      xcomp_act_obj_nconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$xcomp_act_obj_nconj_aP = NA
    } else {
      tryCatch({
        xcomp_act_obj_nconj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                        parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                parents(pos = c("VERB", "AUX"),
                                                        children(pos = "VERB", relation = "xcomp",
                                                                 label = "act", fill = F,
                                                                 NOT(lemma = "have"),
                                                                 not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                 not_children(relation = "nsubj"),
                                                                 children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                          label = "Patient", fill = F,
                                                                          children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                   label = "Patient", fill = F, depth = 3
                                                                          )
                                                                 )
                                                        )
                                                )
                                        )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_nconj_aP", xcomp_act_obj_nconj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$xcomp_act_obj_nconj_aP))){
          xcomp_act_obj_nconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          xcomp_act_obj_nconj_aP_casted = cast_text(tokens, 'xcomp_act_obj_nconj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        xcomp_act_obj_nconj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$xcomp_act_obj_nconj_aP <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of verb with xcomp clause, conjuncted transitive verb, and ENTITY as subject conjunct
    ##### Example: "Jonathan and ENTITY want to swim and eat rice, grapes, and, steak." (eat, rice grapes steak)
    ##### Example: "Jonathan and ENTITY want to swim and give Steven a present." (give, Steven present)
    ##### Note: not_children inserted is to avoid passiveness.
    if(fast){
      xcomp_act_obj_nconj_vconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
      tokens$xcomp_act_obj_nconj_vconj_aP = NA
    } else {
      tryCatch({
        xcomp_act_obj_nconj_vconj_aP = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                              parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                      parents(pos = c("VERB", "AUX"),
                                                              children(pos = "VERB", relation = "xcomp",
                                                                       not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                       not_children(relation = "nsubj"),
                                                                       NOT(lemma = "have"),
                                                                       children(pos = "VERB", relation = "conj",
                                                                                label = "act", fill = F,
                                                                                children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                                         label = "Patient", fill = F,
                                                                                         children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                                  label = "Patient", fill = F, depth = 3
                                                                                         )
                                                                                )
                                                                       )

                                                              )
                                                      )
                                              )
        )

        tokens = tokens %>%
          annotate_tqueries("xcomp_act_obj_nconj_vconj_aP", xcomp_act_obj_nconj_vconj_aP, overwrite = T, copy = F)

        if(all(is.na(tokens$xcomp_act_obj_nconj_vconj_aP))){
          xcomp_act_obj_nconj_vconj_aP_casted = data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        } else {
          xcomp_act_obj_nconj_vconj_aP_casted = cast_text(tokens, 'xcomp_act_obj_nconj_vconj_aP', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting action-patient motifs. Some action-patient motifs might not have been extracted properly.")
        xcomp_act_obj_nconj_vconj_aP_casted <<- data.table(doc_id = character(), ann_id = factor(), act = character(), Patient = character())
        tokens$xcomp_act_obj_nconj_vconj_aP <<- NA
      })
    }
  }


  ###############################################################################################
  ########################################Treatments#############################################
  ###############################################################################################
  if("t" %in% motif_classes){
    if(verbose){cat("Extracting treatments\n")}
    ###############################################################################################
    ##### Rule: Object of nsubj act
    ##### Example: "Joe calls ENTITY." (calls)
    ##### Example: "Joe gives Michael a ENTITY." (gives)
    tryCatch({
      dobj_treat = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("dobj", "dative"),
                          parents(pos = "VERB",
                                  label = "Motif",
                                  fill = F)
      )

      tokens = tokens %>% annotate_tqueries("dobj_treat", dobj_treat, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting treatment motifs. Some treatment motifs might not have been extracted properly.")
      tokens$dobj_treat <<- NA
    })



    ###############################################################################################
    ##### Rule: noun conjunct of object of nsubj act
    ##### Example: "Joe calls Steve and ENTITY." (calls)
    ##### Example: "Joe gives Steve an apple and an ENTITY." (gives)

    ##### Note: We can't collect more verbs because based on the grammar, it will be
    ##### unclear whether these will be transitive.
    if(fast){
      tokens$dobj_conj_treat = NA
    } else {
      tryCatch({
        dobj_conj_treat = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                 parents(relation = c("dobj", "dative"), pos = c("NOUN", "PROPN", "PRON"),
                                         parents(pos = "VERB",
                                                 label = "Motif",
                                                 fill = F
                                         )
                                 )
        )

        tokens = tokens %>% annotate_tqueries("dobj_conj_treat", dobj_conj_treat, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting treatment motifs. Some treatment motifs might not have been extracted properly.")
        tokens$dobj_conj_treat <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive construction treatment
    ##### Example: "ENTITY is asked." (asked)
    if(fast){
      tokens$obj_of_by_act = NA
    } else {
      tryCatch({
        obj_of_by_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("nsubjpass"),
                               parents(pos = "VERB",
                                       label = "Motif", fill = F
                               )
        )

        tokens = tokens %>%
          annotate_tqueries("obj_of_by_act", obj_of_by_act, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting treatment motifs. Some treatment motifs might not have been extracted properly.")
        tokens$obj_of_by_act <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Passive construction treatment and noun conjunct (entity)
    ##### Example: "Sue and ENTITY are asked." (asked)
    ##### Example: "Steve were given apples and ENTITY." (given)
    if(fast){
      tokens$obj_of_by_act_nconj = NA
    } else {
      tryCatch({
        obj_of_by_act_nconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                     parents(pos = c("NOUN", "PROPN", "PRON"), relation = c("nsubjpass"),
                                             parents(pos = "VERB",
                                                     label = "Motif", fill = F
                                             )
                                     )
        )

        tokens = tokens %>%
          annotate_tqueries("obj_of_by_act_nconj", obj_of_by_act_nconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting treatment motifs. Some treatment motifs might not have been extracted properly.")
        tokens$obj_of_by_act_nconj <<- NA
      })
    }
  }


  ###############################################################################################
  ###########################################Agent###############################################
  ###############################################################################################

  if("A" %in% motif_classes){
    if(verbose){cat("Extracting agents\n")}
    ###############################################################################################
    ##### Rule: Actor of nsubj act with object
    ##### Example: "Joseph, Sarah, and Steve call ENTITY." (Joe, Sarah, Steve)
    ##### Example: "Joseph, Sarah, and Steve give Michael a ENTITY." (Joe, Sarah, Steve)
    tryCatch({
      dobj_treat_actor = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("dobj", "dative"),
                                parents(pos = "VERB",
                                        children(pos = agent_patient_pos, relation = "nsubj",
                                                 label = "Motif", fill = F,
                                                 children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                          label = "Motif", fill = F, depth = 3
                                                 )
                                        )
                                )
      )

      tokens = tokens %>% annotate_tqueries("dobj_treat_actor", dobj_treat_actor, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting agent motifs. Some agent motifs might not have been extracted properly.")
      tokens$dobj_treat_actor <<- NA
    })



    ###############################################################################################
    ##### Rule: Actor of conjuncted nsubj act with object
    ##### Example: "Joseph, Sarah, and Steve came and asked ENTITY." (Joe, Sarah, Steve)
    ##### Example: "They ran and attacked ENTITY" (They)
    tryCatch({
      dobj_treat_conj_actor = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("dobj", "dative"),
                                     parents(pos = "VERB", relation = c("conj","xcomp"),
                                             not_children(pos = agent_patient_pos, relation = "nsubj"),
                                             parents(pos = c("VERB", "AUX"),
                                                     children(pos = agent_patient_pos, relation = "nsubj",
                                                              label = "Motif", fill = F,
                                                              children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                       label = "Motif", fill = F, depth = 3
                                                              )
                                                     )
                                             )
                                     )
      )
      tokens = tokens %>% annotate_tqueries("dobj_treat_conj_actor", dobj_treat_conj_actor, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting agent motifs. Some agent motifs might not have been extracted properly.")
      tokens$dobj_treat_conj_actor <<- NA
    })



    ###############################################################################################
    ##### Rule: Actor of nsubj act with object and a noun conjunct (entity)
    ##### Example: "Joseph, Sarah, and Steve call Michael and ENTITY." (Joseph, Sarah, Steve)
    ##### Example: "Joseph, Sarah, and Steve give Michael an apple and an ENTITY." (Joseph, Sarah, and Steve)
    ##### Note: We can't collect more verbs because based on the grammar, it will be
    ##### unclear whether these will be transitive.
    if(fast){
      tokens$dobj_nconj_treat = NA
    } else {
      tryCatch({
        dobj_nconj_treat = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                  parents(relation = c("dobj", "dative"), pos = c("NOUN", "PROPN", "PRON"),
                                          parents(pos = "VERB",
                                                  children(pos = agent_patient_pos, relation = "nsubj",
                                                           label = "Motif", fill = F,
                                                           children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                    label = "Motif", fill = F, depth = 3
                                                           )
                                                  )
                                          )
                                  )
        )

        tokens = tokens %>% annotate_tqueries("dobj_nconj_treat", dobj_nconj_treat, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting agent motifs. Some agent motifs might not have been extracted properly.")
        tokens$dobj_nconj_treat <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Actor of by act with object
    ##### Example: "ENTITY is asked by Peter, Joseph, and Sue." (Peter Joseph Sue)
    ##### Example: "Steven was given ENTITY by Peter, Joseph, and Sue" (Peter Joseph Sue)
    if(fast){
      tokens$by_act_agent = NA
    } else {
      tryCatch({
        by_act_agent = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("nsubjpass", "dobj"),
                              parents(pos = "VERB",
                                      children(pos = "ADP", lemma = "by", relation = "agent",
                                               children(pos = agent_patient_pos, relation = "pobj",
                                                        label = "Motif", fill = F,
                                                        children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                 label = "Motif", fill = F, depth = 3
                                                        )
                                               )
                                      )
                              )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_agent", by_act_agent, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting agent motifs. Some agent motifs might not have been extracted properly.")
        tokens$by_act_agent <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Actor of by act with object and noun conjunct (entity)
    ##### Example: "Sue and ENTITY are asked by Peter, Joseph, and Sue." (Peter, Joseph, Sue)
    ##### Example: "Steve were given apples and ENTITY by Peter, Joseph, and Sue." (Peter, Joseph, Sue)
    if(fast){
      tokens$obj_of_by_act_nconj_ac = NA
    } else {
      tryCatch({
        obj_of_by_act_nconj_ac = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                        parents(pos = c("NOUN", "PROPN", "PRON"), relation = c("nsubjpass"),
                                                parents(pos = "VERB",
                                                        children(pos = "ADP", lemma = "by", relation = "agent",
                                                                 children(pos = agent_patient_pos, relation = "pobj",
                                                                          label = "Motif", fill = F,
                                                                          children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                   label = "Motif", fill = F, depth = 3
                                                                          )
                                                                 )
                                                        )
                                                )
                                        )
        )

        tokens = tokens %>%
          annotate_tqueries("obj_of_by_act_nconj_ac", obj_of_by_act_nconj_ac, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting agent motifs. Some agent motifs might not have been extracted properly.")
        tokens$obj_of_by_act_nconj_ac <<- NA
      })
    }
  }

  ###############################################################################################
  ###################################Agents & Treatments#########################################
  ###############################################################################################
  if("At" %in% motif_classes){
    if(verbose){cat("Extracting agent-treatments\n")}
    ###############################################################################################
    ##### Rule: Actor of nsubj act with object
    ##### Example: "Joseph, Sarah, and Steve call ENTITY." (Joe Sarah Steve, call)
    ##### Example: "Joseph, Sarah, and Steve give Michael a ENTITY." (Joe Sarah Steve, give)
    tryCatch({
      dobj_treat_actor_At = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("dobj", "dative"),
                                   parents(pos = "VERB",
                                           label = "treatment", fill = F,
                                           children(pos = agent_patient_pos, relation = "nsubj",
                                                    label = "Agent", fill = F,
                                                    children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                             label = "Agent", fill = F, depth = 3
                                                    )
                                           )
                                   )
      )

      tokens = tokens %>% annotate_tqueries("dobj_treat_actor_At", dobj_treat_actor_At, overwrite = T, copy = F)

      if(all(is.na(tokens$dobj_treat_actor_At))){
        dobj_treat_actor_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      } else {
        dobj_treat_actor_At_casted = cast_text(tokens, 'dobj_treat_actor_At', text_col = extract)
      }
    }, error = function(e){
      message("There was an error in extracting agent-treatment motifs. Some agent-treatment motifs might not have been extracted properly.")
      dobj_treat_actor_At_casted <<- data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      tokens$dobj_treat_actor_At <<- NA
    })



    ###############################################################################################
    ##### Rule: Actor of conjuncted nsubj act with object
    ##### Example: "Joseph, Sarah, and Steve came and asked ENTITY." (Joe Sarah Steve, yell)
    if(fast){
      dobj_treat_conj_actor_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      tokens$dobj_treat_conj_actor_At = NA
    } else {
      tryCatch({
        dobj_treat_conj_actor_At = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("dobj", "dative"),
                                          parents(pos = "VERB", relation = c("conj","xcomp"),
                                                  label = "treatment", fill = F,
                                                  not_children(pos = agent_patient_pos, relation = "nsubj"),
                                                  parents(pos = c("VERB", "AUX"),
                                                          children(pos = agent_patient_pos, relation = "nsubj",
                                                                   label = "Agent", fill = F,
                                                                   children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                            label = "Agent", fill = F, depth = 3
                                                                   )
                                                          )
                                                  )
                                          )
        )

        tokens = tokens %>% annotate_tqueries("dobj_treat_conj_actor_At", dobj_treat_conj_actor_At, overwrite = T, copy = F)

        if(all(is.na(tokens$dobj_treat_conj_actor_At))){
          dobj_treat_conj_actor_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        } else {
          dobj_treat_conj_actor_At_casted = cast_text(tokens, 'dobj_treat_conj_actor_At', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting agent-treatment motifs. Some agent-treatment motifs might not have been extracted properly.")
        dobj_treat_conj_actor_At_casted <<- data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        tokens$dobj_treat_conj_actor_At <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Actor of nsubj act with object and a noun conjunct (entity)
    ##### Example: "Joseph, Sarah, and Steve call Michael and ENTITY." (Joseph Sarah Steve, call)
    ##### Example: "Joseph, Sarah, and Steve give Michael an apple and an ENTITY." (Joseph Sarah Steve, give)
    ##### Note: We can't collect more verbs because based on the grammar, it will be
    ##### unclear whether these will be transitive.
    if(fast){
      dobj_nconj_treat_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      tokens$dobj_nconj_treat_At = NA
    } else {
      tryCatch({
        dobj_nconj_treat_At = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                     parents(relation = c("dobj", "dative"), pos = c("NOUN", "PROPN", "PRON"),
                                             parents(pos = "VERB",
                                                     label = "treatment", fill = F,
                                                     children(pos = agent_patient_pos, relation = "nsubj",
                                                              label = "Agent", fill = F,
                                                              children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                       label = "Agent", fill = F, depth = 3
                                                              )
                                                     )
                                             )
                                     )
        )

        tokens = tokens %>% annotate_tqueries("dobj_nconj_treat_At", dobj_nconj_treat_At, overwrite = T, copy = F)

        if(all(is.na(tokens$dobj_nconj_treat_At))){
          dobj_nconj_treat_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        } else {
          dobj_nconj_treat_At_casted = cast_text(tokens, 'dobj_nconj_treat_At', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting agent-treatment motifs. Some agent-treatment motifs might not have been extracted properly.")
        dobj_nconj_treat_At_casted <<- data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        tokens$dobj_nconj_treat_At <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Actor of by act with object
    ##### Example: "ENTITY is asked by Peter, Joseph, and Sue." (Peter Joseph Sue, ask)
    ##### Example: "Steven was given ENTITY by Peter, Joseph, and Sue." (Peter Joseph Sue, give)
    if(fast){
      by_act_agent_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      tokens$by_act_agent_At = NA
    } else {
      tryCatch({
        by_act_agent_At = tquery(OR(token = entities, appos_child = "appos_child"), relation = c("nsubjpass", "dobj"),
                                 parents(pos = "VERB",
                                         label = "treatment", fill = F,
                                         children(pos = "ADP", lemma = "by", relation = "agent",
                                                  children(pos = agent_patient_pos, relation = "pobj",
                                                           label = "Agent", fill = F,
                                                           children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                    label = "Agent", fill = F, depth = 3
                                                           )
                                                  )
                                         )
                                 )
        )

        tokens = tokens %>%
          annotate_tqueries("by_act_agent_At", by_act_agent_At, overwrite = T, copy = F)

        if(all(is.na(tokens$by_act_agent_At))){
          by_act_agent_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        } else {
          by_act_agent_At_casted = cast_text(tokens, 'by_act_agent_At', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting agent-treatment motifs. Some agent-treatment motifs might not have been extracted properly.")
        by_act_agent_At_casted <<- data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        tokens$by_act_agent_At <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Actor of by act with object and noun conjunct (entity)
    ##### Example: "Sue and ENTITY are asked by Peter, Joseph, and Sue." (Peter, ask)
    ##### Example: "Steve were given apples and ENTITY by Peter, Joseph, and Sue." (Peter, give)
    if(fast){
      obj_of_by_act_nconj_ac_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
      tokens$obj_of_by_act_nconj_ac_At = NA
    } else {
      tryCatch({
        obj_of_by_act_nconj_ac_At = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                           parents(pos = c("NOUN", "PROPN", "PRON"), relation = c("nsubjpass", "dobj"),
                                                   parents(pos = "VERB",
                                                           label = "treatment", fill = F,
                                                           children(pos = "ADP", lemma = "by", relation = "agent",
                                                                    children(pos = agent_patient_pos, relation = "pobj",
                                                                             label = "Agent", fill = F,
                                                                             children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                      label = "Agent", fill = F, depth = 3
                                                                             )
                                                                    )
                                                           )
                                                   )
                                           )
        )

        tokens = tokens %>%
          annotate_tqueries("obj_of_by_act_nconj_ac_At", obj_of_by_act_nconj_ac_At, overwrite = T, copy = F)

        if(all(is.na(tokens$obj_of_by_act_nconj_ac_At))){
          obj_of_by_act_nconj_ac_At_casted = data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        } else {
          obj_of_by_act_nconj_ac_At_casted = cast_text(tokens, 'obj_of_by_act_nconj_ac_At', text_col = extract)
        }
      }, error = function(e){
        message("There was an error in extracting agent-treatment motifs. Some agent-treatment motifs might not have been extracted properly.")
        obj_of_by_act_nconj_ac_At_casted <<- data.table(doc_id = character(), ann_id = factor(), treatment = character(), Agent = character())
        tokens$obj_of_by_act_nconj_ac_At <<- NA
      })
    }


  }

  ###############################################################################################
  #####################################Characterizations#########################################
  ###############################################################################################

  if("be" %in% motif_classes){
    if(verbose){cat("Extracting characterizations\n")}
    ###############################################################################################
    ##### Rule: Being adjective
    ##### Example: "ENTITY is nice but dumb." (nice, dumb)
    ##### Example: "ENTITY is a winner and nice." (winner, nice)
    ##### Example: "ENTITY looks nice." (nice)
    tryCatch({
      being_adj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                         parents(pos = c("AUX", "VERB"),
                                 children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("acomp", "attr"), phrase_replacement = NA,
                                          label = "Motif",
                                          fill = F,
                                          children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("conj", "appos", "amod"), req = F, phrase_replacement = NA,
                                                   label = "Motif",
                                                   fill = F, depth = 3
                                          )
                                 )
                         )
      )

      tokens = tokens %>% annotate_tqueries("being_adj", being_adj, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
      tokens$being_adj <<- NA
    })



    ###############################################################################################
    ##### Rule: Being adjective noun conjunct
    ##### Example: "Steve and ENTITY are nice, humble, and cool persons." (nice)
    if(fast){
      tokens$being_adj_nconj = NA
    } else {
      tryCatch({
        being_adj_nconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                 parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                         parents(pos = c("AUX", "VERB"),
                                                 children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("acomp", "attr"), phrase_replacement = NA,
                                                          label = "Motif",
                                                          fill = F,
                                                          children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("conj", "appos", "amod"), req = F, phrase_replacement = NA,
                                                                   label = "Motif",
                                                                   fill = F, depth = 3
                                                          )
                                                 )
                                         )
                                 )
        )

        tokens = tokens %>% annotate_tqueries("being_adj_nconj", being_adj_nconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
        tokens$being_adj_nconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Appos parents
    ##### Example: "My friend ENTITY came." (friend)
    if(fast){
      tokens$appos_char = NA
    } else {
      tryCatch({
        appos_char = tquery(appos_child = "appos_child",
                            phrase_replacement = NA,
                            label = "Motif",
                            fill = F
        )


        tokens = tokens %>% annotate_tqueries("appos_char", appos_char, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
        tokens$appos_char <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Being adjective as conjuncted verb
    ##### Example: "ENTITY won but remained sad and unmoved." (sad, unmoved)
    if(fast){
      tokens$being_adj_vconj = NA
    } else {
      tryCatch({
        being_adj_vconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                 parents(pos = c("VERB", "AUX"),
                                         children(pos = c("AUX", "VERB"), relation = "conj",
                                                  not_children(relation = "nsubj", depth = 1),
                                                  children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("acomp", "attr"), phrase_replacement = NA,
                                                           label = "Motif",
                                                           fill = F,
                                                           children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("conj", "appos", "amod"), req = F, phrase_replacement = NA,
                                                                    label = "Motif",
                                                                    fill = F, depth = 3
                                                           )
                                                  )
                                         )
                                 )
        )

        tokens = tokens %>% annotate_tqueries("being_adj_vconj", being_adj_vconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
        tokens$being_adj_vconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Being something as xcomp clause verb
    ##### Example: "ENTITY wants to be president." (president)
    ##### Example: "ENTITY tries to be a good president." (good, president)
    if(fast){
      tokens$being_adj_xcomp = NA
    } else {
      tryCatch({
        being_adj_xcomp = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                 parents(pos = c("VERB", "AUX"),
                                         children(pos = c("AUX", "VERB"), relation = "xcomp",
                                                  not_children(relation = "nsubj", depth = 1),
                                                  children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("acomp", "attr"), phrase_replacement = NA,
                                                           label = "Motif",
                                                           fill = F,
                                                           children(pos = c("ADJ", "NOUN", "PROPN"), relation = c("conj", "appos", "amod"), req = F, phrase_replacement = NA,
                                                                    label = "Motif",
                                                                    fill = F, depth = 3
                                                           )
                                                  )
                                         )
                                 )
        )

        tokens = tokens %>% annotate_tqueries("being_adj_xcomp", being_adj_xcomp, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
        tokens$being_adj_xcomp <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Amod adjective
    ##### Example: "Steven got a nice, young ENTITY." (nice)
    tryCatch({
      amod_adj = tquery(OR(token = entities, appos_child = "appos_child"),
                        children(pos = "ADJ", relation = "amod", phrase_replacement = NA,
                                 label = "Motif",
                                 fill = F))

      tokens = tokens %>% annotate_tqueries("amod_adj", amod_adj, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
      tokens$amod_adj <<- NA
    })

    if(be_entity){
      ###############################################################################################
      ##### Rule: Being an entity
      ##### Example: "His favorite cousin was entity." (cousin)
      tryCatch({
        being_entity = tquery(OR(token = entities, appos_child = "appos_child"), relation = "attr",
                              parents(pos = c("VERB", "AUX"), lemma = "be",
                                      children(pos = c("NOUN", "PROPN"), relation = "nsubj",
                                               phrase_replacement = NA,
                                               label = "Motif",
                                               fill = F)
                              )
        )

        tokens = tokens %>% annotate_tqueries("being_entity", being_entity, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
        tokens$being_entity <<- NA
      })



      ###############################################################################################
      ##### Rule: Being an entity with conjunct
      ##### Example: "His favorite cousins were Steve and ENTITY." (cousin)
      if(fast){
        tokens$being_entity_c = NA
      } else {
        tryCatch({
          being_entity_c = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                  parents(pos = c("NOUN", "PROPN", "PRON"), relation = "attr",
                                          parents(pos = c("VERB", "AUX"), lemma = "be",
                                                  children(pos = c("NOUN", "PROPN"), relation = "nsubj",
                                                           phrase_replacement = NA,
                                                           label = "Motif",
                                                           fill = F)
                                          )
                                  )
          )

          tokens = tokens %>% annotate_tqueries("being_entity_c", being_entity_c, overwrite = T, copy = F)
          tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
        }, error = function(e){
          message("There was an error in extracting characterization motifs. Some characterization motifs might not have been extracted properly.")
          tokens$being_entity_c <<- NA
        })
      }
    } else {
      tokens$being_entity = NA
      tokens$being_entity_c = NA
    }
  }





  ###############################################################################################
  ########################################Posessions#############################################
  ###############################################################################################
  if("H" %in% motif_classes){
    if(verbose){cat("Extracting possessions\n")}
    ###############################################################################################
    ##### Rule: A possesive of entity
    ##### Example: "He liked ENTITY's frinds, spouse, and family." (friends, spouse, family)
    tryCatch({
      posessive_o = tquery(OR(token = entities, appos_child = "appos_child"), relation = "poss",
                           parents(pos = c("NOUN", "PROPN"),
                                   label = "Motif",
                                   fill = F,
                                   children(pos = c("NOUN", "PROPN"), relation = "conj", req = F,
                                            label = "Motif",
                                            fill = F,
                                            children(pos = c("NOUN", "PROPN"), relation = "conj", req = F,
                                                     label = "Motif",
                                                     fill = F
                                            )
                                   )
                           )
      )

      tokens = tokens %>% annotate_tqueries("posessive_o", posessive_o, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
    }, error = function(e){
      message("There was an error in extracting posession motifs. Some posession motifs might not have been extracted properly.")
      tokens$posessive_o <<- NA
    })



    ###############################################################################################
    ##### Rule: A possesive of entity
    ##### Example: "The breaks of the ENTITIY were broken." (breaks)
    ##### Note: we look for both parent and children conjunctions because the dependency trees predicted acan be highly
    #####       irregular on this regard.
    if(fast){
      tokens$posessive_of = NA
    } else {
      tryCatch({
        posessive_of = tquery(OR(token = entities, appos_child = "appos_child"), relation = "pobj",
                             parents(token =  "of", relation = "prep",
                                     parents(pos = c("NOUN", "PROPN"),
                                             label = "Motif",
                                             fill = F,
                                             parents(pos = c("NOUN", "PROPN"), relation = "conj", req = F,
                                                      label = "Motif",
                                                      fill = F
                                             ),
                                             children(pos = c("NOUN", "PROPN"), relation = "conj", req = F,
                                                      label = "Motif",
                                                      fill = F,
                                                      children(pos = c("NOUN", "PROPN"), relation = "conj", req = F,
                                                               label = "Motif",
                                                               fill = F
                                                      )
                                             )
                                      )
                             )
        )

        tokens = tokens %>% annotate_tqueries("posessive_of", posessive_of, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL
      }, error = function(e){
        message("There was an error in extracting posession motifs. Some posession motifs might not have been extracted properly.")
        tokens$posessive_of <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of nsubj have act
    ##### Example: "ENTITY has apples, grapes, and bananas. (apples, grapes, bananas)
    tryCatch({
      have_nsubj_obj_conj_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                       parents(pos = c("VERB", "AUX"), lemma = "have",
                                               children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Motif",
                                                        fill = F,
                                                        children(pos = agent_patient_pos, relation = c("conj", "appos"), depth = 3, req = F,
                                                                 label = "Motif",
                                                                 fill = F
                                                        )
                                               )
                                       )
      )

      tokens = tokens %>% annotate_tqueries("have_nsubj_obj_conj_act", have_nsubj_obj_conj_act, overwrite = T, copy = F)
      tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

    }, error = function(e){
      message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
      tokens$have_nsubj_obj_conj_act <<- NA
    })



    ###############################################################################################
    ##### Rule: Object of nsubj have act with conjunct noun
    ##### Example: "Joe and ENTITY have apples." (apples)
    if(fast){
      tokens$have_nsubj_obj_conj = NA
    } else {
      tryCatch({
        have_nsubj_obj_conj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                     parents(pos = agent_patient_pos, relation = "nsubj",
                                             parents(pos = c("VERB", "AUX"), lemma = "have",
                                                     children(pos = agent_patient_pos, relation = c("dobj", "dative"), label = "Motif",
                                                              fill = F,
                                                              children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                       label = "Motif", fill = F, depth = 3
                                                              )
                                                     )
                                             )
                                     )
        )

        tokens = tokens %>% annotate_tqueries("have_nsubj_obj_conj", have_nsubj_obj_conj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
      })
    }



    ###############################################################################################
    ##### Rule: Object of second conjuncted have verb
    ##### Example: "ENTITY came and had a cakes." (cake)
    if(fast){
      tokens$have_nsubj_conj_obj_act = NA
    } else {
      tryCatch({
        have_nsubj_conj_obj_act = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                         parents(pos = c("VERB", "AUX"),
                                                 children(pos = c("VERB", "AUX"), relation = "conj",
                                                          lemma = "have",
                                                          not_children(relation = "nsubj", depth = 1),
                                                          children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                   label = "Motif",
                                                                   fill = F,
                                                                   children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                            label = "Motif", req = F, depth = 3,
                                                                            fill = F
                                                                   )
                                                          )
                                                 )
                                         )
        )


        tokens = tokens %>%
          annotate_tqueries("have_nsubj_conj_obj_act", have_nsubj_conj_obj_act, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_nsubj_conj_obj_act <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of second conjuncted have verb with actor in conjunct position.
    ##### Example: "Joe and ENTITY came and had a cake." (Joe, Sue, Michael)
    if(fast){
      tokens$have_nsubj_conj_subj_cons_obj = NA
    } else {
      tryCatch({
        have_nsubj_conj_subj_cons_obj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                               parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                       parents(pos = c("VERB", "AUX"),
                                                               children(pos = c("VERB", "AUX"), relation = "conj",
                                                                        lemma = "have",
                                                                        not_children(relation = "nsubj", depth = 1),
                                                                        children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                                 label = "Motif",
                                                                                 fill = F,
                                                                                 children(pos = agent_patient_pos, relation = c("conj", "appos"),
                                                                                          label = "Motif", req = F, depth = 3,
                                                                                          fill = F
                                                                                 )
                                                                        )
                                                               )
                                                       )
                                               )
        )

        tokens = tokens %>%
          annotate_tqueries("have_nsubj_conj_subj_cons_obj", have_nsubj_conj_subj_cons_obj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_nsubj_conj_subj_cons_obj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause have verb
    ##### Example: "ENTITY wants to have rice." (rice)
    if(fast){
      tokens$have_xcomp_act_obj = NA
    } else {
      tryCatch({
        have_xcomp_act_obj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                    parents(pos = c("VERB", "AUX"),
                                            children(pos = c("VERB", "AUX"), relation = "xcomp",
                                                     lemma = "have",
                                                     not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                     not_children(relation = "nsubj"),
                                                     children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                              label = "Motif", fill = F,
                                                              children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                       label = "Motif", fill = F, depth = 3
                                                              )
                                                     )
                                            )
                                    )
        )

        tokens = tokens %>%
          annotate_tqueries("have_xcomp_act_obj", have_xcomp_act_obj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_xcomp_act_obj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Object of verb with xcomp clause and have-verb conjunct
    ##### Example: "ENTITY wants to eat and have a conversation." (rice, grapes, steak)
    if(fast){
      tokens$have_xcomp_act_obj_vconj = NA
    } else {
      tryCatch({
        have_xcomp_act_obj_vconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "nsubj",
                                          parents(pos = c("VERB", "AUX"),
                                                  children(pos = "VERB", relation = "xcomp",
                                                           not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                           not_children(relation = "nsubj"),
                                                           children(pos = c("VERB", "AUX"), relation = "conj",
                                                                    lemma = "have",
                                                                    children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                             label = "Motif", fill = F,
                                                                             children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                      label = "Motif", fill = F, depth = 3
                                                                             )
                                                                    )
                                                           )
                                                  )
                                          )
        )

        tokens = tokens %>%
          annotate_tqueries("have_xcomp_act_obj_vconj", have_xcomp_act_obj_vconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_xcomp_act_obj_vconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of have-verb with xcomp clause and noun conjunct and subject
    ##### Example: "Jonathan and ENTITY want to have rice." (rice)
    if(fast){
      tokens$have_xcomp_act_obj_nconj = NA
    } else {
      tryCatch({
        have_xcomp_act_obj_nconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                          parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                  parents(pos = c("VERB", "AUX"),
                                                          children(pos = c("VERB", "AUX"), relation = "xcomp",
                                                                   not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                   not_children(relation = "nsubj"),
                                                                   lemma = "have",
                                                                   children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                            label = "Motif", fill = F,
                                                                            children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                     label = "Motif", fill = F, depth = 3
                                                                            )
                                                                   )
                                                          )
                                                  )
                                          )
        )

        tokens = tokens %>%
          annotate_tqueries("have_xcomp_act_obj_nconj", have_xcomp_act_obj_nconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_xcomp_act_obj_nconj <<- NA
      })
    }



    ###############################################################################################
    ##### Rule: Objects of have-verb with xcomp clause and noun and verb conjunct
    ##### Example: "Jonathan and ENTITY want to swim and eat lunch." (lunch)
    if(fast){
      tokens$have_xcomp_act_obj_nconj_vconj = NA
    } else {
      tryCatch({
        have_xcomp_act_obj_nconj_vconj = tquery(OR(token = entities, appos_child = "appos_child"), relation = "conj",
                                                parents(pos = c("NOUN", "PROPN", "PRON"), relation = "nsubj",
                                                        parents(pos = c("VERB", "AUX"),
                                                                children(pos = "VERB", relation = "xcomp",
                                                                         not_children(pos = "AUX", lemma = "be", relation = "auxpass"),
                                                                         not_children(relation = "nsubj"),
                                                                         children(pos = c("VERB", "AUX"), relation = "conj",
                                                                                  lemma = "have",
                                                                                  children(pos = agent_patient_pos, relation = c("dobj", "dative"),
                                                                                           label = "Motif", fill = F,
                                                                                           children(pos = agent_patient_pos, relation = c("conj", "appos"), req = F,
                                                                                                    label = "Motif", fill = F, depth = 3
                                                                                           )
                                                                                  )
                                                                         )

                                                                )
                                                        )
                                                )
        )

        tokens = tokens %>%
          annotate_tqueries("have_xcomp_act_obj_nconj_vconj", have_xcomp_act_obj_nconj_vconj, overwrite = T, copy = F)
        tokens[,c(ncol(tokens)-1,ncol(tokens))] = NULL

      }, error = function(e){
        message("There was an error in extracting possession motifs. Some possession motifs might not have been extracted properly.")
        tokens$have_xcomp_act_obj_nconj_vconj <<- NA
      })
    }
  }


  ###############################################################################################
  ######################################Lowercase extractions####################################
  ###############################################################################################

  ###############################################################################################
  ##### Lowercase
  if(lowercase){
    tokens$token = tolower(tokens$token)
    tokens$lemma = tolower(tokens$lemma)
  }


  ###############################################################################################
  ###################################Combine the motifs to a list################################
  ###############################################################################################

  ##### Define columns
  act_cols = c("nsubj_act_conj", "nsubj_act_noun_conj_verb_conj",
                "by_act", "by_act_noun_conjunct", "by_act_2", "by_act_2_1", "by_act_2_noun_conj",
                "by_act_2_noun_conj_1", "xcomp_act_conj_verb", "xcomp_act_conj_noun")
  patient_cols = c("nsubj_obj_conj_act","nsubj_obj_conj", "nsubj_conj_obj_act", "nsubj_conj_subj_cons_obj",
                   "by_act_obj", "by_act_obj_nc", "by_act_obj_cverb", "by_act_obj_cverb_cobj", "xcomp_act_obj",
                   "xcomp_act_obj_vconj", "xcomp_act_obj_nconj", "xcomp_act_obj_nconj_vconj")
  treatment_cols = c("dobj_treat", "dobj_conj_treat", "obj_of_by_act", "obj_of_by_act_nconj")
  agent_cols = c("dobj_treat_actor", "dobj_treat_conj_actor", "dobj_nconj_treat", "by_act_agent", "obj_of_by_act_nconj_ac")
  characterization_cols = c("being_adj", "being_adj_nconj", "being_adj_vconj", "being_adj_xcomp", "appos_char", "amod_adj", "being_entity", "being_entity_c")
  possession_cols = c("posessive_o", "posessive_of",
                       "have_nsubj_obj_conj_act", "have_nsubj_obj_conj", "have_nsubj_conj_obj_act",
                       "have_nsubj_conj_subj_cons_obj", "have_xcomp_act_obj",
                       "have_xcomp_act_obj_vconj", "have_xcomp_act_obj_nconj", "have_xcomp_act_obj_nconj_vconj")
  all_cols = c(act_cols, patient_cols, treatment_cols, agent_cols, characterization_cols, possession_cols)
  all_cols = subset(all_cols, all_cols %in% colnames(tokens))

  ##### Transform tokens object
  tokens = semgram:::motif_replace_helper(annotated_tokens = tokens, motif_names = all_cols, extract_p = extract)

  ##### Get motifs
  acts = if("a" %in% motif_classes){unlist(tokens[,..act_cols], use.names = FALSE)} else {NA}
  if(markup){
    acts = if(length(acts[!is.na(acts)]) > 0){paste0("a_", acts[!is.na(acts)])} else {character(0)}
  } else {
    acts = if(length(acts[!is.na(acts)]) > 0){paste0(acts[!is.na(acts)])} else {character(0)}
  }

  patients = if("P" %in% motif_classes){unlist(tokens[,..patient_cols], use.names = FALSE)} else {NA}
  if(markup){
    patients = if(length(patients[!is.na(patients)]) > 0){paste0("P_", patients[!is.na(patients)])} else {character(0)}
  } else {
    patients = if(length(patients[!is.na(patients)]) > 0){paste0(patients[!is.na(patients)])} else {character(0)}
  }

  treatments = if("t" %in% motif_classes){unlist(tokens[,..treatment_cols], use.names = FALSE)} else {NA}
  if(markup){
    treatments = if(length(treatments[!is.na(treatments)]) > 0){paste0("t_", treatments[!is.na(treatments)])} else {character(0)}
  } else {
    treatments = if(length(treatments[!is.na(treatments)]) > 0){paste0(treatments[!is.na(treatments)])} else {character(0)}
  }

  agents = if("A" %in% motif_classes){unlist(tokens[,..agent_cols], use.names = FALSE)} else {NA}
  if(markup){
    agents = if(length(agents[!is.na(agents)]) > 0){paste0("A_", agents[!is.na(agents)])} else {character(0)}
  } else {
    agents = if(length(agents[!is.na(agents)]) > 0){paste0(agents[!is.na(agents)])} else {character(0)}
  }

  characterizations = if("be" %in% motif_classes){unlist(tokens[,..characterization_cols], use.names = FALSE)} else {NA}
  if(markup){
    characterizations = if(length(characterizations[!is.na(characterizations)]) > 0){paste0("be_", characterizations[!is.na(characterizations)])} else {character(0)}
  } else {
    characterizations = if(length(characterizations[!is.na(characterizations)]) > 0){paste0(characterizations[!is.na(characterizations)])} else {character(0)}
  }

  possessions = if("H" %in% motif_classes){unlist(tokens[,..possession_cols], use.names = FALSE)} else {NA}
  if(markup){
    possessions = if(length(possessions[!is.na(possessions)]) > 0){paste0("H_", possessions[!is.na(possessions)])} else {character(0)}
  } else {
    possessions = if(length(possessions[!is.na(possessions)]) > 0){paste0(possessions[!is.na(possessions)])} else {character(0)}
  }


  agent_treatments = if("At" %in% motif_classes){
    agent_treatments = rbind(dobj_treat_actor_At_casted,
                             dobj_treat_conj_actor_At_casted,
                             dobj_nconj_treat_At_casted,
                             by_act_agent_At_casted,
                             obj_of_by_act_nconj_ac_At_casted)
    if(lowercase){
      agent_treatments$treatment = tolower(agent_treatments$treatment)
      agent_treatments$Agent = tolower(agent_treatments$Agent)
    }

    agent_treatments$Agent_split = str_split(agent_treatments$Agent," ")
    if(nrow(agent_treatments)>0){as.vector(unlist(apply(agent_treatments, 1, semgram:::custom_paste_At, markup)))}else{character(0)}
    } else {character(0)}

  action_Patients = if("aP" %in% motif_classes){
    action_Patients = rbind(nsubj_obj_conj_act_aP_casted,
                             nsubj_obj_conj_aP_casted,
                             nsubj_conj_obj_act_aP_casted,
                             nsubj_conj_subj_cons_obj_aP_casted,
                             by_act_obj_aP_casted,
                             by_act_obj_nc_aP_casted,
                             by_act_obj_cverb_1_aP_casted,
                             by_act_obj_cverb_2_aP_casted,
                             by_act_obj_cverb_cobj_1_aP_casted,
                             by_act_obj_cverb_cobj_2_aP_casted,
                             xcomp_act_obj_aP_casted,
                             xcomp_act_obj_vconj_aP_casted,
                             xcomp_act_obj_nconj_aP_casted,
                             xcomp_act_obj_nconj_vconj_aP_casted)
    if(lowercase){
      action_Patients$act = tolower(action_Patients$act)
      action_Patients$Patient = tolower(action_Patients$Patient)
    }
    action_Patients$Patient_split = str_split(action_Patients$Patient," ")
    if(nrow(action_Patients)>0){as.vector(unlist(apply(action_Patients, 1, semgram:::custom_paste_aP, markup)))}else{character(0)}
    } else {character(0)}
  ##### Combine to list object
  motif_list = list("acts" = acts, "patients" = patients, "treatments" = treatments, "agents" = agents,
                    "characterizations" = characterizations, "possessions" = possessions,
                    "agent_treatments" = agent_treatments,
                    "action_Patients" = action_Patients)


  ###############################################################################################
  ###########################################Return##############################################
  ###############################################################################################
  return(motif_list)
}
